{% extends "base.html" %}

{% block title %}Spending - Perfin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-wallet"></i> Spending Tracker</h1>
        <p class="text-muted">Track your daily expenses</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Today's Spending</h5>
                <h2 class="text-primary">${{ "%.2f"|format(today_total) }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Period Total</h5>
                <h2 class="text-{% if period_total > budget_period.budget_amount %}danger{% elif period_total > budget_period.budget_amount * 0.8 %}warning{% else %}success{% endif %}">
                    ${{ "%.2f"|format(period_total) }}
                </h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Remaining Budget</h5>
                <h2 class="text-{% if (budget_period.budget_amount - period_total) < 0 %}danger{% else %}success{% endif %}">
                    ${{ "%.2f"|format(budget_period.budget_amount - period_total) }}
                </h2>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-plus"></i> Add Expense</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_spending') }}" id="addExpenseForm">
                    <div class="mb-3">
                        <label for="date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="date" name="date"
                               value="{{ today }}" required>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Items</label>
                    </div>

                    <div id="expenseRows">
                        <div class="expense-row mb-2">
                            <div class="row g-2">
                                <div class="col-7">
                                    <input type="text" class="form-control" name="items[]"
                                           placeholder="e.g., Slushie" required>
                                </div>
                                <div class="col-4">
                                    <input type="number" class="form-control" name="prices[]"
                                           step="0.01" min="0.01" placeholder="2.00" required>
                                </div>
                                <div class="col-1 d-flex align-items-center">
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-row"
                                            onclick="removeExpenseRow(this)" style="display: none;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-outline-secondary btn-sm w-100 mb-2"
                            onclick="addExpenseRow()">
                        <i class="fas fa-plus"></i> Add Another Item
                    </button>

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-save"></i> <span id="submitText">Add Expense</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> Spending Entries</h5>
                <span class="badge bg-light text-dark">
                    Period: {{ budget_period.start_date }} to {{ budget_period.end_date }}
                </span>
            </div>
            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                {% if period_spending %}
                    {% set current_date = '' %}
                    {% for entry in period_spending %}
                        {% if entry.date != current_date %}
                            {% set current_date = entry.date %}
                            <h6 class="mt-3 mb-2 text-muted border-bottom">{{ entry.date }}</h6>
                        {% endif %}
                        <div class="spending-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ entry.item }}</strong>
                                <small class="text-muted ms-2">{{ entry.created_at.strftime('%H:%M') if entry.created_at else '' }}</small>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-primary me-2">${{ "%.2f"|format(entry.price) }}</span>
                                <button type="button" class="btn btn-sm btn-outline-primary me-1"
                                        onclick="editSpending({{ entry.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <form method="POST" action="{{ url_for('delete_spending', entry_id=entry.id) }}"
                                      style="display: inline;"
                                      onsubmit="return confirm('Are you sure you want to delete this entry?')">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No spending entries for this period.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Edit Spending Modal - Custom Implementation -->
<div id="editSpendingModalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; min-width: 400px; z-index: 1000000;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 15px;">
            <h5 style="margin: 0; color: #333;"><i class="fas fa-edit"></i> Edit Spending Entry</h5>
            <button onclick="closeEditSpendingModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>

        <form id="editSpendingForm" method="POST">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">Date</label>
                <input type="date" id="edit_date" name="date" required
                       style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 5px; font-size: 16px; background: white;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">Item</label>
                <input type="text" id="edit_item" name="item" required
                       style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 5px; font-size: 16px; background: white;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">Price ($)</label>
                <input type="number" id="edit_price" name="price" step="0.01" min="0.01" required
                       style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 5px; font-size: 16px; background: white;">
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeEditSpendingModal()"
                        style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Cancel
                </button>
                <button type="submit"
                        style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Custom modal functions (same approach as dashboard)
function openEditSpendingModal() {
    document.getElementById('editSpendingModalOverlay').style.display = 'block';
    // Allow scrolling - remove the overflow hidden

    // Focus on the item input after a brief delay
    setTimeout(() => {
        const input = document.getElementById('edit_item');
        if (input) {
            input.focus();
            input.select();
        }
    }, 100);
}

function closeEditSpendingModal() {
    document.getElementById('editSpendingModalOverlay').style.display = 'none';
    // No need to restore scrolling since we never disabled it
}

// Close modal when pressing ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' || e.key === 'Esc') {
        const overlay = document.getElementById('editSpendingModalOverlay');
        if (overlay && overlay.style.display !== 'none') {
            closeEditSpendingModal();
        }
    }
});

function editSpending(entryId) {
    // Fetch entry data
    fetch(`/spending/edit/${entryId}`)
        .then(response => response.json())
        .then(data => {
            // Populate form fields
            document.getElementById('edit_date').value = data.date;
            document.getElementById('edit_item').value = data.item;
            document.getElementById('edit_price').value = data.price;

            // Set form action
            document.getElementById('editSpendingForm').action = `/spending/edit/${entryId}`;

            // Show custom modal
            openEditSpendingModal();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading spending entry');
        });
}

// Removed click-outside-to-close functionality - only X button closes modal

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEditSpendingModal();
    }
});

// Multiple expense row functions
function addExpenseRow() {
    const expenseRows = document.getElementById('expenseRows');
    const newRow = document.createElement('div');
    newRow.className = 'expense-row mb-2';
    newRow.innerHTML = `
        <div class="row g-2">
            <div class="col-7">
                <input type="text" class="form-control" name="items[]"
                       placeholder="e.g., Slushie" required>
            </div>
            <div class="col-4">
                <input type="number" class="form-control" name="prices[]"
                       step="0.01" min="0.01" placeholder="2.00" required>
            </div>
            <div class="col-1 d-flex align-items-center">
                <button type="button" class="btn btn-sm btn-outline-danger remove-row"
                        onclick="removeExpenseRow(this)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    expenseRows.appendChild(newRow);

    // Focus on the new item input
    const itemInput = newRow.querySelector('input[name="items[]"]');
    if (itemInput) {
        itemInput.focus();
    }

    updateRemoveButtons();
    updateSubmitText();
}

function removeExpenseRow(button) {
    const row = button.closest('.expense-row');
    row.remove();
    updateRemoveButtons();
    updateSubmitText();
}

function updateRemoveButtons() {
    const rows = document.querySelectorAll('.expense-row');
    rows.forEach((row, index) => {
        const removeBtn = row.querySelector('.remove-row');
        if (removeBtn) {
            removeBtn.style.display = rows.length > 1 ? 'inline-block' : 'none';
        }
    });
}

function updateSubmitText() {
    const rowCount = document.querySelectorAll('.expense-row').length;
    const submitText = document.getElementById('submitText');
    if (submitText) {
        submitText.textContent = rowCount > 1 ? `Add ${rowCount} Expenses` : 'Add Expense';
    }
}
</script>

{% endblock %}