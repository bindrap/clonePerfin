{% extends "base.html" %}

{% block title %}AI Assistant - Perfin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-robot"></i> AI Financial Assistant</h1>
        <p class="text-muted">Ask questions about your spending, personal habits, portfolio, condo, and savings</p>
    </div>
</div>

<!-- API Configuration Card -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-cog"></i> Ollama API Configuration</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="ollamaUrl" class="form-label">Ollama API URL</label>
                        <input type="text" class="form-control" id="ollamaUrl"
                               value="https://api.ollama.ai/api/generate"
                               placeholder="https://api.ollama.ai/api/generate">
                        <small class="form-text text-muted">Or use local: http://localhost:11434/api/generate</small>
                    </div>
                    <div class="col-md-3">
                        <label for="ollamaApiKey" class="form-label">API Key (Optional)</label>
                        <input type="password" class="form-control" id="ollamaApiKey"
                               placeholder="Enter API key if required">
                    </div>
                    <div class="col-md-3">
                        <label for="ollamaModel" class="form-label">Model</label>
                        <select class="form-control" id="ollamaModel">
                            <option value="llama3.2">llama3.2</option>
                            <option value="llama3.1">llama3.1</option>
                            <option value="llama3">llama3</option>
                            <option value="llama2">llama2</option>
                            <option value="mistral">mistral</option>
                            <option value="mixtral">mixtral</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="saveConfig()">
                        <i class="fas fa-save"></i> Save Configuration
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="testConnection()">
                        <i class="fas fa-plug"></i> Test Connection
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Example Questions Card -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-lightbulb"></i> Example Questions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Spending Insights:</h6>
                        <ul class="list-unstyled">
                            <li><button class="btn btn-link btn-sm p-0" onclick="askQuestion('What did I spend the most on this month?')">
                                üí∞ What did I spend the most on this month?
                            </button></li>
                            <li><button class="btn btn-link btn-sm p-0" onclick="askQuestion('How much did I spend on food and dining?')">
                                üçî How much did I spend on food and dining?
                            </button></li>
                            <li><button class="btn btn-link btn-sm p-0" onclick="askQuestion('What are my top 5 spending categories?')">
                                üìä What are my top 5 spending categories?
                            </button></li>
                        </ul>
                        <h6>Personal Habits:</h6>
                        <ul class="list-unstyled">
                            <li><button class="btn btn-link btn-sm p-0" onclick="askQuestion('How often did I go to the gym this month?')">
                                üí™ How often did I go to the gym this month?
                            </button></li>
                            <li><button class="btn btn-link btn-sm p-0" onclick="askQuestion('What are my most consistent activities?')">
                                üèÉ What are my most consistent activities?
                            </button></li>
                            <li><button class="btn btn-link btn-sm p-0" onclick="askQuestion('How can I improve my health habits?')">
                                üåü How can I improve my health habits?
                            </button></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Portfolio & Investments:</h6>
                        <ul class="list-unstyled">
                            <li><button class="btn btn-link btn-sm p-0" onclick="askQuestion('How is my portfolio performing?')">
                                üìà How is my portfolio performing?
                            </button></li>
                            <li><button class="btn btn-link btn-sm p-0" onclick="askQuestion('What is my current profit or loss?')">
                                üíπ What is my current profit or loss?
                            </button></li>
                            <li><button class="btn btn-link btn-sm p-0" onclick="askQuestion('Should I rebalance my portfolio?')">
                                ‚öñÔ∏è Should I rebalance my portfolio?
                            </button></li>
                        </ul>
                        <h6>Condo & Savings:</h6>
                        <ul class="list-unstyled">
                            <li><button class="btn btn-link btn-sm p-0" onclick="askQuestion('What is my net monthly income from my condo?')">
                                üè† What is my net monthly income from my condo?
                            </button></li>
                            <li><button class="btn btn-link btn-sm p-0" onclick="askQuestion('Am I on track with my savings goals?')">
                                üéØ Am I on track with my savings goals?
                            </button></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chat Container -->
<div class="row">
    <div class="col-12">
        <div class="card" style="height: 600px; display: flex; flex-direction: column;">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-comments"></i> Chat with AI Assistant</h5>
            </div>
            <div class="card-body" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column;" id="chatContainer">
                <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 10px;">
                    <div class="chat-message assistant-message">
                        <div class="message-bubble">
                            <strong>AI Assistant:</strong><br>
                            Hello! I'm your AI financial assistant. I have access to your spending data, personal activities,
                            portfolio information, condo finances, and savings goals. Feel free to ask me anything about your
                            financial life, and I'll provide insights based on your actual data! üí°
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="input-group">
                    <input type="text" class="form-control" id="userMessage"
                           placeholder="Ask about your finances..."
                           onkeypress="handleKeyPress(event)">
                    <button class="btn btn-primary" onclick="sendMessage()" id="sendButton">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
#chatMessages {
    background: #f8f9fa;
    border-radius: 8px;
    min-height: 400px;
}

.chat-message {
    margin-bottom: 15px;
    display: flex;
}

.user-message {
    justify-content: flex-end;
}

.assistant-message {
    justify-content: flex-start;
}

.message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 12px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    word-wrap: break-word;
}

.user-message .message-bubble {
    background: #007bff;
    color: white;
    border-bottom-right-radius: 4px;
}

.assistant-message .message-bubble {
    background: white;
    color: #333;
    border-bottom-left-radius: 4px;
    border: 1px solid #dee2e6;
}

.loading-message {
    font-style: italic;
    color: #6c757d;
}

.error-message .message-bubble {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

@media (max-width: 768px) {
    .message-bubble {
        max-width: 85%;
        font-size: 0.9rem;
        padding: 10px 12px;
    }
}
</style>

<script>
// Load saved configuration from localStorage
document.addEventListener('DOMContentLoaded', function() {
    const savedUrl = localStorage.getItem('ollamaUrl');
    const savedApiKey = localStorage.getItem('ollamaApiKey');
    const savedModel = localStorage.getItem('ollamaModel');

    if (savedUrl) document.getElementById('ollamaUrl').value = savedUrl;
    if (savedApiKey) document.getElementById('ollamaApiKey').value = savedApiKey;
    if (savedModel) document.getElementById('ollamaModel').value = savedModel;
});

function saveConfig() {
    const url = document.getElementById('ollamaUrl').value;
    const apiKey = document.getElementById('ollamaApiKey').value;
    const model = document.getElementById('ollamaModel').value;

    localStorage.setItem('ollamaUrl', url);
    localStorage.setItem('ollamaApiKey', apiKey);
    localStorage.setItem('ollamaModel', model);

    alert('Configuration saved successfully!');
}

function testConnection() {
    const url = document.getElementById('ollamaUrl').value;

    if (!url) {
        alert('Please enter an Ollama API URL');
        return;
    }

    // Show loading state
    const testBtn = event.target.closest('button');
    const originalHTML = testBtn.innerHTML;
    testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    testBtn.disabled = true;

    // Simple test - try to reach the endpoint
    fetch(url.replace('/api/generate', '/api/tags'), {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => {
        testBtn.innerHTML = originalHTML;
        testBtn.disabled = false;

        if (response.ok) {
            alert('‚úÖ Connection successful! Ollama API is reachable.');
        } else {
            alert('‚ö†Ô∏è Connection established but got non-OK response. API might still work.');
        }
    })
    .catch(error => {
        testBtn.innerHTML = originalHTML;
        testBtn.disabled = false;
        alert('‚ùå Connection failed: ' + error.message + '\n\nMake sure:\n1. URL is correct\n2. Ollama is running\n3. CORS is enabled if using cloud API');
    });
}

function askQuestion(question) {
    document.getElementById('userMessage').value = question;
    sendMessage();
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function sendMessage() {
    const messageInput = document.getElementById('userMessage');
    const message = messageInput.value.trim();

    if (!message) return;

    // Add user message to chat
    addMessageToChat('user', message);

    // Clear input
    messageInput.value = '';

    // Get configuration
    const ollamaUrl = document.getElementById('ollamaUrl').value;
    const apiKey = document.getElementById('ollamaApiKey').value;
    const model = document.getElementById('ollamaModel').value;

    // Show loading message
    const loadingId = addLoadingMessage();

    // Disable send button
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Thinking...';

    // Send to backend
    fetch('/api/ai/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            message: message,
            ollama_url: ollamaUrl,
            api_key: apiKey,
            model: model
        })
    })
    .then(response => response.json())
    .then(data => {
        // Remove loading message
        removeLoadingMessage(loadingId);

        // Re-enable send button
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> Send';

        if (data.success) {
            addMessageToChat('assistant', data.response);
        } else {
            addMessageToChat('error', 'Error: ' + (data.error || 'Unknown error occurred'));
        }
    })
    .catch(error => {
        // Remove loading message
        removeLoadingMessage(loadingId);

        // Re-enable send button
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> Send';

        addMessageToChat('error', 'Network error: ' + error.message);
    });
}

function addMessageToChat(type, message) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');

    if (type === 'user') {
        messageDiv.className = 'chat-message user-message';
        messageDiv.innerHTML = `
            <div class="message-bubble">
                <strong>You:</strong><br>${escapeHtml(message)}
            </div>
        `;
    } else if (type === 'assistant') {
        messageDiv.className = 'chat-message assistant-message';
        messageDiv.innerHTML = `
            <div class="message-bubble">
                <strong>AI Assistant:</strong><br>${formatAssistantMessage(message)}
            </div>
        `;
    } else if (type === 'error') {
        messageDiv.className = 'chat-message error-message';
        messageDiv.innerHTML = `
            <div class="message-bubble">
                <strong>Error:</strong><br>${escapeHtml(message)}
            </div>
        `;
    }

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addLoadingMessage() {
    const chatMessages = document.getElementById('chatMessages');
    const loadingDiv = document.createElement('div');
    const loadingId = 'loading-' + Date.now();

    loadingDiv.id = loadingId;
    loadingDiv.className = 'chat-message assistant-message loading-message';
    loadingDiv.innerHTML = `
        <div class="message-bubble">
            <i class="fas fa-spinner fa-spin"></i> AI is thinking...
        </div>
    `;

    chatMessages.appendChild(loadingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    return loadingId;
}

function removeLoadingMessage(loadingId) {
    const loadingDiv = document.getElementById(loadingId);
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

function formatAssistantMessage(message) {
    // Convert markdown-style formatting to HTML
    let formatted = escapeHtml(message);

    // Bold text **text**
    formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

    // Italic text *text*
    formatted = formatted.replace(/\*(.+?)\*/g, '<em>$1</em>');

    // Line breaks
    formatted = formatted.replace(/\n/g, '<br>');

    // Code blocks `code`
    formatted = formatted.replace(/`(.+?)`/g, '<code style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px;">$1</code>');

    return formatted;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
