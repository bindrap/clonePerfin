{% extends "base.html" %}

{% block title %}AI Assistant - Perfin{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <h1><i class="fas fa-robot"></i> AI Financial Assistant</h1>
        <p class="text-muted">Ask me anything about your spending, personal habits, portfolio, condo, and savings</p>
    </div>
</div>

<!-- Example Questions Card -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <button class="btn btn-sm btn-light float-end" onclick="toggleExamples()" id="toggleExamplesBtn">
                    <i class="fas fa-chevron-up"></i>
                </button>
                <h5><i class="fas fa-lightbulb"></i> Example Questions</h5>
            </div>
            <div class="card-body" id="examplesBody">
                <div class="row">
                    <div class="col-md-3">
                        <h6 class="text-primary">üí∞ Spending</h6>
                        <div class="d-flex flex-column gap-1">
                            <button class="btn btn-sm btn-outline-primary text-start" onclick="askQuestion('What did I spend the most on this month?')">
                                What did I spend the most on?
                            </button>
                            <button class="btn btn-sm btn-outline-primary text-start" onclick="askQuestion('How much did I spend on food?')">
                                How much on food?
                            </button>
                            <button class="btn btn-sm btn-outline-primary text-start" onclick="askQuestion('What are my top 5 categories?')">
                                Top 5 categories?
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-success">üí™ Personal Habits</h6>
                        <div class="d-flex flex-column gap-1">
                            <button class="btn btn-sm btn-outline-success text-start" onclick="askQuestion('How often did I go to the gym?')">
                                How often gym?
                            </button>
                            <button class="btn btn-sm btn-outline-success text-start" onclick="askQuestion('What are my most consistent activities?')">
                                Most consistent activities?
                            </button>
                            <button class="btn btn-sm btn-outline-success text-start" onclick="askQuestion('How can I improve my health habits?')">
                                Improve health habits?
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-info">üìà Portfolio</h6>
                        <div class="d-flex flex-column gap-1">
                            <button class="btn btn-sm btn-outline-info text-start" onclick="askQuestion('How is my portfolio performing?')">
                                Portfolio performance?
                            </button>
                            <button class="btn btn-sm btn-outline-info text-start" onclick="askQuestion('What is my profit or loss?')">
                                Current profit/loss?
                            </button>
                            <button class="btn btn-sm btn-outline-info text-start" onclick="askQuestion('Should I rebalance my portfolio?')">
                                Rebalance portfolio?
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-warning">üè† Condo & Savings</h6>
                        <div class="d-flex flex-column gap-1">
                            <button class="btn btn-sm btn-outline-warning text-start" onclick="askQuestion('What is my net monthly condo income?')">
                                Condo net income?
                            </button>
                            <button class="btn btn-sm btn-outline-warning text-start" onclick="askQuestion('Am I on track with my savings goals?')">
                                Savings goal progress?
                            </button>
                            <button class="btn btn-sm btn-outline-warning text-start" onclick="askQuestion('Give me a complete financial overview')">
                                Complete overview?
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chat Container - ChatGPT Style -->
<div class="row">
    <div class="col-12">
        <div class="card chat-card">
            <div class="card-body p-0">
                <div id="chatMessages" class="chat-messages">
                    <div class="chat-message assistant">
                        <div class="message-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-text">
                                Hello! I'm your AI financial assistant. I have access to your spending data, personal activities,
                                portfolio information, condo finances, and savings goals. Ask me anything! üí°
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer border-top bg-white">
                <div class="input-container">
                    <textarea
                        id="userMessage"
                        class="form-control chat-input"
                        placeholder="Ask me about your finances..."
                        rows="1"
                        onkeydown="handleKeyDown(event)"></textarea>
                    <button class="btn btn-primary send-button" onclick="sendMessage()" id="sendButton">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Chat Card Styling */
.chat-card {
    height: calc(100vh - 380px);
    min-height: 500px;
    display: flex;
    flex-direction: column;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
    scroll-behavior: smooth;
}

/* Message Styling */
.chat-message {
    display: flex;
    margin-bottom: 24px;
    gap: 12px;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.chat-message.user {
    flex-direction: row-reverse;
}

.message-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 18px;
}

.chat-message.assistant .message-icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.chat-message.user .message-icon {
    background: #007bff;
    color: white;
}

.message-content {
    flex: 1;
    max-width: 80%;
}

.message-text {
    background: white;
    padding: 12px 16px;
    border-radius: 12px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    line-height: 1.6;
    word-wrap: break-word;
}

.chat-message.user .message-text {
    background: #007bff;
    color: white;
}

.loading-dots {
    display: inline-flex;
    gap: 4px;
    align-items: center;
}

.loading-dots span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #667eea;
    animation: bounce 1.4s infinite ease-in-out both;
}

.loading-dots span:nth-child(1) { animation-delay: -0.32s; }
.loading-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes bounce {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
}

/* Input Container */
.input-container {
    display: flex;
    gap: 12px;
    padding: 16px;
    background: white;
}

.chat-input {
    border: 2px solid #e9ecef;
    border-radius: 24px;
    padding: 12px 20px;
    font-size: 15px;
    resize: none;
    max-height: 120px;
    transition: border-color 0.2s;
}

.chat-input:focus {
    border-color: #007bff;
    box-shadow: none;
}

.send-button {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    flex-shrink: 0;
    transition: all 0.2s;
}

.send-button:hover:not(:disabled) {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,123,255,0.3);
}

.send-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Error Message */
.message-text.error {
    background: #fee;
    color: #c00;
    border-left: 4px solid #c00;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .chat-card {
        height: calc(100vh - 320px);
        min-height: 400px;
    }

    .chat-messages {
        padding: 12px;
    }

    .message-content {
        max-width: 85%;
    }

    .message-text {
        padding: 10px 14px;
        font-size: 14px;
    }

    .message-icon {
        width: 32px;
        height: 32px;
        font-size: 16px;
    }

    .input-container {
        padding: 12px;
        gap: 8px;
    }

    .chat-input {
        font-size: 14px;
        padding: 10px 16px;
    }

    .send-button {
        width: 44px;
        height: 44px;
    }
}
</style>

<script>
let isExamplesVisible = true;

function toggleExamples() {
    isExamplesVisible = !isExamplesVisible;
    const body = document.getElementById('examplesBody');
    const btn = document.getElementById('toggleExamplesBtn');

    if (isExamplesVisible) {
        body.style.display = 'block';
        btn.innerHTML = '<i class="fas fa-chevron-up"></i>';
    } else {
        body.style.display = 'none';
        btn.innerHTML = '<i class="fas fa-chevron-down"></i>';
    }
}

function askQuestion(question) {
    document.getElementById('userMessage').value = question;
    sendMessage();

    // Collapse examples after selection
    if (window.innerWidth < 768) {
        isExamplesVisible = true;
        toggleExamples();
    }
}

function handleKeyDown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function sendMessage() {
    const messageInput = document.getElementById('userMessage');
    const message = messageInput.value.trim();

    if (!message) return;

    // Add user message to chat
    addMessageToChat('user', message);

    // Clear input
    messageInput.value = '';
    messageInput.style.height = 'auto';

    // Show loading message
    const loadingId = addLoadingMessage();

    // Disable send button
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = true;

    // Send to backend
    fetch('/api/ai/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        // Remove loading message
        removeLoadingMessage(loadingId);

        // Re-enable send button
        sendButton.disabled = false;

        if (data.success) {
            addMessageToChat('assistant', data.response);
        } else {
            addMessageToChat('error', 'Error: ' + (data.error || 'Unknown error occurred'));
        }
    })
    .catch(error => {
        // Remove loading message
        removeLoadingMessage(loadingId);

        // Re-enable send button
        sendButton.disabled = false;

        addMessageToChat('error', 'Network error: ' + error.message);
    });
}

function addMessageToChat(type, message) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');

    if (type === 'user') {
        messageDiv.className = 'chat-message user';
        messageDiv.innerHTML = `
            <div class="message-icon">
                <i class="fas fa-user"></i>
            </div>
            <div class="message-content">
                <div class="message-text">${escapeHtml(message)}</div>
            </div>
        `;
    } else if (type === 'assistant') {
        messageDiv.className = 'chat-message assistant';
        messageDiv.innerHTML = `
            <div class="message-icon">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
                <div class="message-text">${formatAssistantMessage(message)}</div>
            </div>
        `;
    } else if (type === 'error') {
        messageDiv.className = 'chat-message assistant';
        messageDiv.innerHTML = `
            <div class="message-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="message-content">
                <div class="message-text error">${escapeHtml(message)}</div>
            </div>
        `;
    }

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addLoadingMessage() {
    const chatMessages = document.getElementById('chatMessages');
    const loadingDiv = document.createElement('div');
    const loadingId = 'loading-' + Date.now();

    loadingDiv.id = loadingId;
    loadingDiv.className = 'chat-message assistant';
    loadingDiv.innerHTML = `
        <div class="message-icon">
            <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
            <div class="message-text">
                <div class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    `;

    chatMessages.appendChild(loadingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    return loadingId;
}

function removeLoadingMessage(loadingId) {
    const loadingDiv = document.getElementById(loadingId);
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

function formatAssistantMessage(message) {
    // Convert markdown-style formatting to HTML
    let formatted = escapeHtml(message);

    // Bold text **text**
    formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

    // Italic text *text*
    formatted = formatted.replace(/\*(.+?)\*/g, '<em>$1</em>');

    // Line breaks
    formatted = formatted.replace(/\n/g, '<br>');

    // Code blocks `code`
    formatted = formatted.replace(/`(.+?)`/g, '<code style="background: #f1f3f5; padding: 2px 6px; border-radius: 4px; font-family: monospace;">$1</code>');

    // Lists (- item)
    formatted = formatted.replace(/^- (.+)$/gm, '‚Ä¢ $1');

    return formatted;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Auto-resize textarea
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('userMessage');

    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
});
</script>
{% endblock %}
