{% extends "base.html" %}

{% block title %}Analytics - Perfin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-chart-bar"></i> Advanced Analytics</h1>
        <p class="text-muted">Deep insights into your spending patterns and trends</p>
    </div>
</div>

<!-- Time Period Overview -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body analytics-metric">
                <h5 class="card-title">Last 7 Days</h5>
                <h2 class="text-primary">${{ "%.2f"|format(weekly_total) }}</h2>
                <small class="text-muted">Weekly spending</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body analytics-metric">
                <h5 class="card-title">Last 30 Days</h5>
                <h2 class="text-info">${{ "%.2f"|format(monthly_total) }}</h2>
                <small class="text-muted">Monthly spending</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body analytics-metric">
                <h5 class="card-title">Last 90 Days</h5>
                <h2 class="text-warning">${{ "%.2f"|format(quarterly_total) }}</h2>
                <small class="text-muted">Quarterly spending</small>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Category Analysis -->
{% if detailed_categories %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-tags"></i> Detailed Spending by Category</h5>
                <small>Based on individual item tracking</small>
            </div>
            <div class="card-body">
                {% for category in detailed_categories %}
                <div class="d-flex justify-content-between align-items-center mb-2 {% if category.category == 'Other' %}category-clickable{% endif %}"
                     {% if category.category == 'Other' %}onclick="showOtherCategoryModal(event)" style="cursor: pointer;"{% endif %}>
                    <div>
                        <span class="fw-bold">{{ category.category }}</span>
                        <small class="text-muted">({{ category.count }} items)</small>
                        {% if category.category == 'Other' %}
                        <i class="fas fa-info-circle text-info ms-2" title="Click to see breakdown"></i>
                        {% endif %}
                    </div>
                    <span class="badge bg-primary">${{ "%.2f"|format(category.total) }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-star"></i> Top Spending Items</h5>
                <small>Most expensive individual purchases</small>
            </div>
            <div class="card-body">
                {% for item in top_items %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <span class="fw-bold">{{ item.item_name }}</span>
                        <small class="text-muted">({{ item.frequency }}x)</small>
                    </div>
                    <span class="badge bg-secondary">${{ "%.2f"|format(item.total) }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Weekly Trends Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> Weekly Spending Trends</h5>
            </div>
            <div class="card-body">
                <canvas id="weeklyTrendsChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Charts -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-area"></i> Category Trends (6 Months)</h5>
            </div>
            <div class="card-body">
                <canvas id="categoryTrendsChart" height="300"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Overall Daily Average & Monthly Trends</h5>
            </div>
            <div class="card-body">
                <canvas id="weeklyAveragesChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Activity Analytics -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-dumbbell"></i> Activity Analytics & Habits</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-light">
                            <div class="card-header bg-light">
                                <h6><i class="fas fa-chart-pie"></i> Activity Frequency</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="activityFrequencyChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-light">
                            <div class="card-header bg-light">
                                <h6><i class="fas fa-calendar-check"></i> Weekly Activity Patterns</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="weeklyActivityChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card border-light">
                            <div class="card-header bg-light">
                                <h6><i class="fas fa-trophy"></i> Activity Streaks & Insights</h6>
                            </div>
                            <div class="card-body" id="activityInsights">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Loading activity insights...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Stats -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5><i class="fas fa-calculator"></i> Key Insights</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="analytics-metric">
                            <h6>Daily Average (30d)</h6>
                            <h4>${{ "%.2f"|format(monthly_total / 30) }}</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="analytics-metric">
                            <h6>Weekly Average (90d)</h6>
                            <h4>${{ "%.2f"|format(quarterly_total / 13) }}</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="analytics-metric">
                            <h6>Projected Monthly</h6>
                            <h4>${{ "%.2f"|format((weekly_total / 7) * 30) }}</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="analytics-metric">
                            <h6>Budget Efficiency</h6>
                            <h4 class="{% if monthly_total <= 500 %}text-success{% else %}text-danger{% endif %}">
                                {{ "%.1f"|format((monthly_total / 500) * 100) }}%
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Other Category Modal -->
<div id="otherCategoryModalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999999;">
    <div id="otherCategoryModal" style="position: absolute; top: 20%; left: 50%; transform: translate(-50%, 0); background: white; padding: 30px; border-radius: 10px; min-width: 400px; max-width: 90vw; z-index: 1000000;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 15px;">
            <h5 style="margin: 0; color: #333;"><i class="fas fa-tags"></i> "Other" Category Breakdown</h5>
            <button onclick="closeOtherCategoryModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>

        <div id="otherCategoryContent">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin"></i> Loading breakdown...
            </div>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button type="button" onclick="closeOtherCategoryModal()"
                    style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Close
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variable to store the weekly activity chart reference
let weeklyActivityChartInstance = null;

// Custom modal functions
function showOtherCategoryModal(event) {
    const modal = document.getElementById('otherCategoryModal');
    const overlay = document.getElementById('otherCategoryModalOverlay');

    // Get the button's position
    const buttonElement = event.currentTarget;
    const buttonRect = buttonElement.getBoundingClientRect();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

    // Calculate modal position - position it at the same y as the button
    const modalY = buttonRect.top + scrollTop;

    // Ensure the modal doesn't go off screen
    const maxY = Math.max(50, Math.min(modalY, window.innerHeight - 400));

    // Set modal position
    modal.style.top = maxY + 'px';
    modal.style.left = '50%';
    modal.style.transform = 'translate(-50%, 0)';

    overlay.style.display = 'block';
    // Allow scrolling - remove the overflow hidden

    // Load Other category data
    fetch('/api/analytics/other_category')
        .then(response => response.json())
        .then(data => {
            const content = document.getElementById('otherCategoryContent');

            if (data.items && data.items.length > 0) {
                let html = `
                    <div style="margin-bottom: 15px;">
                        <h6>Total: $${data.total.toFixed(2)} (${data.items.length} items)</h6>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                `;

                data.items.forEach((item, index) => {
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px;">
                            <div>
                                <span style="font-weight: bold;">${item.item}</span>
                                <small style="color: #666; display: block;">${item.frequency}x purchases</small>
                            </div>
                            <span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">$${item.total.toFixed(2)}</span>
                        </div>
                    `;
                });

                html += '</div>';
                content.innerHTML = html;
            } else {
                content.innerHTML = `
                    <div style="text-align: center; color: #666;">
                        <i class="fas fa-inbox"></i>
                        <p>No items found in "Other" category</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching Other category data:', error);
            document.getElementById('otherCategoryContent').innerHTML = `
                <div style="text-align: center; color: #dc3545;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Error loading Other category data</p>
                </div>
            `;
        });
}

function closeOtherCategoryModal() {
    document.getElementById('otherCategoryModalOverlay').style.display = 'none';
    // No need to restore scrolling since we never disabled it
}

// Add CSS for clickable category
const style = document.createElement('style');
style.textContent = `
    .category-clickable:hover {
        background-color: rgba(0, 123, 255, 0.1);
        border-radius: 6px;
        transform: translateX(3px);
        transition: all 0.2s ease;
    }
`;
document.head.appendChild(style);

// Weekly Trends Chart
const weeklyData = {{ weekly_trends | tojsonfilter | safe }};
const weeklyCtx = document.getElementById('weeklyTrendsChart').getContext('2d');

new Chart(weeklyCtx, {
    type: 'line',
    data: {
        labels: weeklyData.map(w => `Week ${w.week.split('-')[1]}`),
        datasets: [{
            label: 'Weekly Spending',
            data: weeklyData.map(w => w.total),
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toFixed(2);
                    }
                }
            }
        }
    }
});

// Function to create weekly activity chart with proper coitus visibility
function createWeeklyActivityChart(data) {
    const weeklyCtx = document.getElementById('weeklyActivityChart').getContext('2d');
    
    // Check coitus visibility setting
    const coitusVisible = localStorage.getItem('coitusVisible') !== 'false';
    
    // Define all possible datasets
    const allDatasets = [
        {
            label: 'Gym',
            data: data.weekly_patterns.map(w => w.gym),
            borderColor: '#FF6384',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            fill: false,
            tension: 0.1
        },
        {
            label: 'Jiu Jitsu',
            data: data.weekly_patterns.map(w => w.jiu_jitsu),
            borderColor: '#36A2EB',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            fill: false,
            tension: 0.1
        },
        {
            label: 'Work',
            data: data.weekly_patterns.map(w => w.work),
            borderColor: '#FFCE56',
            backgroundColor: 'rgba(255, 206, 86, 0.1)',
            fill: false,
            tension: 0.1
        },
        {
            label: 'Skateboarding',
            data: data.weekly_patterns.map(w => w.skateboarding),
            borderColor: '#9966FF',
            backgroundColor: 'rgba(153, 102, 255, 0.1)',
            fill: false,
            tension: 0.1
        },
        {
            label: 'Supplements',
            data: data.weekly_patterns.map(w => w.supplements),
            borderColor: '#4BC0C0',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            fill: false,
            tension: 0.1
        }
    ];
    
    // Conditionally add coitus dataset
    if (coitusVisible) {
        allDatasets.push({
            label: 'Coitus',
            data: data.weekly_patterns.map(w => w.coitus),
            borderColor: '#FF9F40',
            backgroundColor: 'rgba(255, 159, 64, 0.1)',
            fill: false,
            tension: 0.1
        });
    }
    
    // Destroy existing chart if it exists
    if (weeklyActivityChartInstance) {
        weeklyActivityChartInstance.destroy();
    }
    
    // Create new chart
    weeklyActivityChartInstance = new Chart(weeklyCtx, {
        type: 'line',
        data: {
            labels: data.weekly_patterns.map(w => w.week),
            datasets: allDatasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 7,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });
}

// Function to update weekly activity chart when coitus visibility changes
function updateWeeklyActivityChart() {
    // Re-fetch data and recreate chart
    fetch('/api/analytics/activities')
        .then(response => response.json())
        .then(data => {
            createWeeklyActivityChart(data);
        })
        .catch(error => {
            console.error('Error updating weekly activity chart:', error);
        });
}

// Fetch and display advanced analytics
fetch('/api/analytics/detailed')
    .then(response => response.json())
    .then(data => {
        // Category Trends Chart
        if (data.category_trends.length > 0) {
            const categoryCtx = document.getElementById('categoryTrendsChart').getContext('2d');
            
            // Process data for stacked chart
            const months = [...new Set(data.category_trends.map(item => item.month))].sort();
            const categories = [...new Set(data.category_trends.map(item => item.category))];
            
            const datasets = categories.map((category, index) => {
                const colors = [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 159, 64, 0.8)',
                    'rgba(199, 199, 199, 0.8)'
                ];
                
                return {
                    label: category,
                    data: months.map(month => {
                        const item = data.category_trends.find(t => t.month === month && t.category === category);
                        return item ? item.total : 0;
                    }),
                    backgroundColor: colors[index % colors.length],
                    borderColor: colors[index % colors.length].replace('0.8', '1'),
                    borderWidth: 1
                };
            });
            
            new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { 
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Overall Daily Average Chart with monthly trends
        if (data.monthly_daily_averages && data.monthly_daily_averages.length > 0) {
            const avgCtx = document.getElementById('weeklyAveragesChart').getContext('2d');
            
            // Add overall average line
            const overallAvg = data.overall_stats ? data.overall_stats.overall_daily_avg : 0;
            
            new Chart(avgCtx, {
                type: 'bar',
                data: {
                    labels: data.monthly_daily_averages.map(m => m.month),
                    datasets: [{
                        label: 'Monthly Daily Average',
                        data: data.monthly_daily_averages.map(m => m.avg_daily_for_month),
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }, {
                        label: `Overall Daily Average ($${overallAvg})`,
                        data: data.monthly_daily_averages.map(m => overallAvg),
                        type: 'line',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Load activity analytics
        loadActivityAnalytics();
    });
    
async function loadActivityAnalytics() {
    try {
        const response = await fetch('/api/analytics/activities');
        const data = await response.json();
        
        // Check coitus visibility for frequency chart
        const coitusVisible = localStorage.getItem('coitusVisible') !== 'false';
        
        // Activity Frequency Pie Chart
        const freqCtx = document.getElementById('activityFrequencyChart').getContext('2d');
        
        let frequencyLabels, frequencyData, frequencyColors;
        
        if (coitusVisible) {
            frequencyLabels = ['Gym', 'Jiu Jitsu', 'Work', 'Supplements', 'Skateboarding', 'Sauna', 'Coitus'];
            frequencyData = [
                data.activity_stats.gym_days,
                data.activity_stats.jj_days,
                data.activity_stats.work_days,
                data.activity_stats.supp_days,
                data.activity_stats.skate_days,
                data.activity_stats.sauna_days,
                data.activity_stats.coitus_days
            ];
            frequencyColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'];
        } else {
            frequencyLabels = ['Gym', 'Jiu Jitsu', 'Work', 'Supplements', 'Skateboarding', 'Sauna'];
            frequencyData = [
                data.activity_stats.gym_days,
                data.activity_stats.jj_days,
                data.activity_stats.work_days,
                data.activity_stats.supp_days,
                data.activity_stats.skate_days,
                data.activity_stats.sauna_days
            ];
            frequencyColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
        }
        
        new Chart(freqCtx, {
            type: 'doughnut',
            data: {
                labels: frequencyLabels,
                datasets: [{
                    data: frequencyData,
                    backgroundColor: frequencyColors
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Create Weekly Activity Pattern Chart
        createWeeklyActivityChart(data);
        
        // Activity Insights
        const insightsDiv = document.getElementById('activityInsights');
        insightsDiv.innerHTML = `
            <div class="row">
                <div class="col-md-3 text-center">
                    <h5 class="text-primary">${data.streaks.gym_current}</h5>
                    <small>Current Gym Streak</small>
                </div>
                <div class="col-md-3 text-center">
                    <h5 class="text-info">${data.streaks.jj_current}</h5>
                    <small>Current JJ Streak</small>
                </div>
                <div class="col-md-3 text-center">
                    <h5 class="text-success">${data.activity_stats.gym_percentage.toFixed(1)}%</h5>
                    <small>Gym Consistency</small>
                </div>
                <div class="col-md-3 text-center">
                    <h5 class="text-warning">${data.activity_stats.jj_percentage.toFixed(1)}%</h5>
                    <small>JJ Consistency</small>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Activity Insights:</h6>
                    <ul class="list-unstyled">
                        ${data.insights.map(insight => `<li><i class="fas fa-lightbulb text-warning"></i> ${insight}</li>`).join('')}
                    </ul>
                </div>
            </div>
        `;
    } catch (error) {
        document.getElementById('activityInsights').innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-exclamation-triangle"></i> Could not load activity analytics
            </div>
        `;
    }
}

// Removed click-outside-to-close functionality - only X button closes modal

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeOtherCategoryModal();
    }
});

// Hook into the global coitus visibility toggle function
document.addEventListener('DOMContentLoaded', function() {
    // Hook into the global coitus visibility toggle function
    const originalToggleCoitusVisibility = window.toggleCoitusVisibility;
    if (originalToggleCoitusVisibility) {
        window.toggleCoitusVisibility = function() {
            originalToggleCoitusVisibility();
            // Small delay to ensure DOM updates are complete
            setTimeout(() => {
                updateWeeklyActivityChart();
                // Also reload the frequency chart
                loadActivityAnalytics();
            }, 100);
        };
    }
});
</script>
{% endblock %}