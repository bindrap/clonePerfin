{% extends "base.html" %}

{% block title %}Dashboard - Perfin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-chart-line"></i> Dashboard</h1>
        <p class="text-muted">Overview of your finances and activities - {{ today }}</p>
    </div>
</div>

<!-- Budget Overview -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-piggy-bank"></i> Current Budget Period</h5>
                <button class="btn btn-sm btn-light" onclick="openBudgetModal()">
                    <i class="fas fa-edit"></i> Edit
                </button>
            </div>
            <div class="card-body">
                <p><strong>Period:</strong> {{ budget_period.start_date }} to {{ budget_period.end_date }}</p>
                <p><strong>Budget:</strong> ${{ "%.2f"|format(budget_period.budget_amount) }}</p>
                <p><strong>Spent:</strong> ${{ "%.2f"|format(total_spent) }}</p>
                <p><strong>Remaining:</strong> ${{ "%.2f"|format(remaining_budget) }}</p>
                <p><strong>Days Left:</strong> {{ days_left }}</p>
                <p><strong>Daily Spend Limit:</strong> ${{ "%.2f"|format(daily_spend_limit) }}</p>

                {% set bar_class =
                    'bg-danger' if total_spent > budget_period.budget_amount
                    else 'bg-warning' if total_spent > budget_period.budget_amount * 0.8
                    else 'bg-success'
                %}
                
                <div class="progress budget-progress mt-3">
                    <div class="progress-bar {{ bar_class }}"
                         style="width: {{ ((total_spent / budget_period.budget_amount) * 100)|round(1) }}%">
                        {{ ((total_spent / budget_period.budget_amount) * 100)|round(1) }}%
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-list-ol"></i> Top Spending Items (Last 30 Days)</h5>
            </div>
            <div class="card-body">
                {% for item in top_spending_items %}
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                    <div>
                        <span class="fw-bold">{{ item.item }}</span>
                        <small class="text-muted d-block">{{ item.frequency }}x purchases</small>
                    </div>
                    <span class="badge bg-success">${{ "%.2f"|format(item.total) }}</span>
                </div>
                {% endfor %}
                {% if not top_spending_items %}
                <p class="text-muted text-center">No spending data for the last 30 days</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Purchases -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-receipt"></i> Recent Purchases (Last 10)</h5>
            </div>
            <div class="card-body">
                {% if recent_purchases %}
                <div class="row">
                    {% for purchase in recent_purchases %}
                    <div class="col-lg-6 col-md-6 col-12 mb-2">
                        <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded spending-item">
                            <div>
                                <span class="fw-bold">{{ purchase.item }}</span>
                                <small class="text-muted d-block">{{ purchase.date.strftime('%b %d, %Y') if purchase.date else 'No date' }}</small>
                            </div>
                            <span class="badge bg-warning text-dark">${{ "%.2f"|format(purchase.price) }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center">No recent purchases found</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Activity Stats -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-running"></i> Activity Stats (Last 30 Days)</h5>
                <small>Percentages show all-time frequency across {{ activity_percentages.total_tracked_days }} tracked days</small>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-2 col-md-3 col-6">
                        <div class="stat-card">
                            <div class="stat-number text-primary">{{ activity_stats.gym_count or 0 }}</div>
                            <div>Gym Sessions</div>
                            <small class="text-muted">({{ activity_percentages.gym_percentage }}% overall)</small>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-3 col-6">
                        <div class="stat-card">
                            <div class="stat-number text-danger">{{ activity_stats.jiu_jitsu_count or 0 }}</div>
                            <div>Jiu Jitsu</div>
                            <small class="text-muted">({{ activity_percentages.jiu_jitsu_percentage }}% overall)</small>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-3 col-6">
                        <div class="stat-card">
                            <div class="stat-number text-warning">{{ activity_stats.skateboarding_count or 0 }}</div>
                            <div>Skateboarding</div>
                            <small class="text-muted">({{ activity_percentages.skateboarding_percentage }}% overall)</small>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-3 col-6">
                        <div class="stat-card">
                            <div class="stat-number text-success">{{ activity_stats.work_count or 0 }}</div>
                            <div>Work Days</div>
                            <small class="text-muted">({{ activity_percentages.work_percentage }}% overall)</small>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-3 col-6 coitus-element">
                        <div class="stat-card">
                            <div class="stat-number text-dark">{{ activity_stats.coitus_count or 0 }}</div>
                            <div>Coitus</div>
                            <small class="text-muted">({{ activity_percentages.coitus_percentage }}% overall)</small>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-3 col-6">
                        <div class="stat-card">
                            <div class="stat-number text-info">{{ activity_stats.sauna_count or 0 }}</div>
                            <div>Sauna</div>
                            <small class="text-muted">({{ activity_percentages.sauna_percentage }}% overall)</small>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-lg-2 col-md-3 col-6 offset-lg-5 offset-md-3">
                        <div class="stat-card">
                            <div class="stat-number text-secondary">{{ activity_stats.supplements_count or 0 }}</div>
                            <div>Supplements</div>
                            <small class="text-muted">({{ activity_percentages.supplements_percentage }}% overall)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> Daily Spending (Last 30 Days)</h5>
            </div>
            <div class="card-body">
                <canvas id="spendingChart" height="300"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Activity Frequency</h5>
            </div>
            <div class="card-body">
                <canvas id="activityChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Budget Update Modal - Completely Rewritten -->
<div id="budgetModalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; min-width: 400px; z-index: 1000000;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 15px;">
            <h5 style="margin: 0; color: #333;"><i class="fas fa-edit"></i> Update Budget Amount</h5>
            <button onclick="closeBudgetModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>
        
        <form id="budgetForm" method="POST" action="{{ url_for('update_budget') }}">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">Budget Amount ($)</label>
                <input type="number" id="budgetAmountInput" name="budget_amount" 
                       step="0.01" min="1" value="{{ budget_period.budget_amount }}" required
                       style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 5px; font-size: 16px; background: white;">
                <small style="color: #666; margin-top: 5px; display: block;">
                    Current period: {{ budget_period.start_date }} to {{ budget_period.end_date }}
                </small>
            </div>
            
            <div style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
                <h6 style="margin: 0 0 10px 0; color: #333;"><i class="fas fa-info-circle"></i> Current Status</h6>
                <p style="margin: 5px 0; color: #333;">Spent: ${{ "%.2f"|format(total_spent) }}</p>
                <p style="margin: 5px 0; color: #333;">Days left: {{ days_left }}</p>
                <p style="margin: 5px 0; color: #333;">
                    <strong>New daily limit: $<span id="newDailyLimitDisplay">{{ "%.2f"|format(daily_spend_limit) }}</span></strong>
                </p>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeBudgetModal()" 
                        style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Cancel
                </button>
                <button type="submit" 
                        style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-save"></i> Update Budget
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables for budget calculation
const totalSpent = {{ total_spent }};
const daysLeft = {{ days_left }};

// Custom modal functions
function openBudgetModal() {
    document.getElementById('budgetModalOverlay').style.display = 'block';
    // Allow scrolling - remove the overflow hidden
    
    // Focus on input after a brief delay
    setTimeout(() => {
        const input = document.getElementById('budgetAmountInput');
        if (input) {
            input.focus();
            input.select();
        }
    }, 100);
}

function closeBudgetModal() {
    document.getElementById('budgetModalOverlay').style.display = 'none';
    // No need to restore scrolling since we never disabled it
}

// Removed click-outside-to-close functionality - only X button closes modal

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeBudgetModal();
    }
});

// Update daily limit calculation when budget amount changes
document.addEventListener('DOMContentLoaded', function() {
    const budgetInput = document.getElementById('budgetAmountInput');
    if (budgetInput) {
        budgetInput.addEventListener('input', function() {
            const newBudget = parseFloat(this.value) || 0;
            const remaining = newBudget - totalSpent;
            const newDailyLimit = remaining / Math.max(daysLeft, 1);
            
            const displayElement = document.getElementById('newDailyLimitDisplay');
            if (displayElement) {
                displayElement.textContent = newDailyLimit.toFixed(2);
            }
        });
    }
});

// Fetch analytics data and create charts
fetch('/api/analytics')
    .then(response => response.json())
    .then(data => {
        // Spending Chart
        const spendingCtx = document.getElementById('spendingChart').getContext('2d');
        const spendingDates = data.daily_spending.map(item => item.date);
        const spendingAmounts = data.daily_spending.map(item => item.total);
        
        new Chart(spendingCtx, {
            type: 'line',
            data: {
                labels: spendingDates,
                datasets: [{
                    label: 'Daily Spending',
                    data: spendingAmounts,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });

        // Activity Chart - Updated to hide coitus when visibility is toggled
        const activityCtx = document.getElementById('activityChart').getContext('2d');
        
        // Check coitus visibility setting
        const coitusVisible = localStorage.getItem('coitusVisible') !== 'false';
        
        let activities, activityLabels, activityCounts;
        
        if (coitusVisible) {
            activities = ['gym', 'jiu_jitsu', 'skateboarding', 'work', 'coitus', 'sauna', 'supplements'];
            activityLabels = ['Gym', 'Jiu Jitsu', 'Skateboarding', 'Work', 'Coitus', 'Sauna', 'Supplements'];
        } else {
            activities = ['gym', 'jiu_jitsu', 'skateboarding', 'work', 'sauna', 'supplements'];
            activityLabels = ['Gym', 'Jiu Jitsu', 'Skateboarding', 'Work', 'Sauna', 'Supplements'];
        }
        
        activityCounts = activities.map(activity => {
            return data.daily_activities.reduce((sum, day) => sum + (day[activity] || 0), 0);
        });
        
        // Colors excluding coitus when hidden
        let backgroundColors, borderColors;
        if (coitusVisible) {
            backgroundColors = [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 205, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)',
                'rgba(199, 199, 199, 0.2)'
            ];
            borderColors = [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 205, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(199, 199, 199, 1)'
            ];
        } else {
            backgroundColors = [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 205, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(255, 159, 64, 0.2)',
                'rgba(199, 199, 199, 0.2)'
            ];
            borderColors = [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 205, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(199, 199, 199, 1)'
            ];
        }
        
        // Store chart reference for later updates
        window.activityChart = new Chart(activityCtx, {
            type: 'bar',
            data: {
                labels: activityLabels,
                datasets: [{
                    label: 'Activity Count',
                    data: activityCounts,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    });

// Function to update the activity chart when coitus visibility changes
function updateActivityChart() {
    if (window.activityChart) {
        // Re-fetch data and update chart
        fetch('/api/analytics')
            .then(response => response.json())
            .then(data => {
                const coitusVisible = localStorage.getItem('coitusVisible') !== 'false';
                
                let activities, activityLabels, activityCounts;
                
                if (coitusVisible) {
                    activities = ['gym', 'jiu_jitsu', 'skateboarding', 'work', 'coitus', 'sauna', 'supplements'];
                    activityLabels = ['Gym', 'Jiu Jitsu', 'Skateboarding', 'Work', 'Coitus', 'Sauna', 'Supplements'];
                } else {
                    activities = ['gym', 'jiu_jitsu', 'skateboarding', 'work', 'sauna', 'supplements'];
                    activityLabels = ['Gym', 'Jiu Jitsu', 'Skateboarding', 'Work', 'Sauna', 'Supplements'];
                }
                
                activityCounts = activities.map(activity => {
                    return data.daily_activities.reduce((sum, day) => sum + (day[activity] || 0), 0);
                });
                
                // Update chart data
                window.activityChart.data.labels = activityLabels;
                window.activityChart.data.datasets[0].data = activityCounts;
                
                // Update colors
                if (coitusVisible) {
                    window.activityChart.data.datasets[0].backgroundColor = [
                        'rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(255, 205, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)', 'rgba(153, 102, 255, 0.2)', 'rgba(255, 159, 64, 0.2)',
                        'rgba(199, 199, 199, 0.2)'
                    ];
                    window.activityChart.data.datasets[0].borderColor = [
                        'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 205, 86, 1)',
                        'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)',
                        'rgba(199, 199, 199, 1)'
                    ];
                } else {
                    window.activityChart.data.datasets[0].backgroundColor = [
                        'rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(255, 205, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)', 'rgba(255, 159, 64, 0.2)', 'rgba(199, 199, 199, 0.2)'
                    ];
                    window.activityChart.data.datasets[0].borderColor = [
                        'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 205, 86, 1)',
                        'rgba(75, 192, 192, 1)', 'rgba(255, 159, 64, 1)', 'rgba(199, 199, 199, 1)'
                    ];
                }
                
                window.activityChart.update();
            });
    }
}

// Hook into the coitus visibility toggle
const originalToggleCoitusVisibility = window.toggleCoitusVisibility;
window.toggleCoitusVisibility = function() {
    originalToggleCoitusVisibility();
    // Small delay to ensure DOM updates are complete
    setTimeout(updateActivityChart, 100);
};
</script>
{% endblock %}