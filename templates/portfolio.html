{% extends "base.html" %}

{% block title %}Portfolio - Perfin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-chart-pie"></i> Portfolio Tracker</h1>
        <p class="text-muted">Track your investment portfolio performance across all your holdings</p>
    </div>
</div>

<!-- Portfolio Overview -->
<div class="row mb-4">
    {% if latest_snapshot %}
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Current Value</h5>
                <h2 class="text-primary">${{ "%.2f"|format(latest_snapshot.total_market_value) }}</h2>
                <small class="text-muted">as of {{ latest_snapshot.date }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Total Invested</h5>
                <h2 class="text-info">${{ "%.2f"|format(latest_snapshot.total_invested) }}</h2>
                <small class="text-muted">all-time contributions</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Profit/Loss</h5>
                <h2 class="{% if latest_snapshot.profit_loss >= 0 %}text-success{% else %}text-danger{% endif %}">
                    ${{ "%.2f"|format(latest_snapshot.profit_loss) }}
                </h2>
                <small class="text-muted">unrealized P/L</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Return %</h5>
                <h2 class="{% if latest_snapshot.profit_loss_percentage >= 0 %}text-success{% else %}text-danger{% endif %}">
                    {{ "%.1f"|format(latest_snapshot.profit_loss_percentage) }}%
                </h2>
                <small class="text-muted">overall return</small>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> Get Started</h5>
            Update your portfolio values below or add your first stock to begin tracking!
        </div>
    </div>
    {% endif %}
</div>

<!-- Holdings Breakdown -->
{% if holdings_list %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5><i class="fas fa-chart-pie"></i> Holdings Breakdown</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th class="text-end">Purchase Value</th>
                                <th class="text-end">Market Value</th>
                                <th class="text-end">P/L ($)</th>
                                <th class="text-end">P/L (%)</th>
                                <th class="text-end">Portfolio %</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for holding in holdings_list %}
                            <tr>
                                <td><strong>{{ holding.symbol }}</strong></td>
                                <td class="text-end">${{ "%.2f"|format(holding.purchase_value) }}</td>
                                <td class="text-end">${{ "%.2f"|format(holding.market_value) }}</td>
                                <td class="text-end {% if holding.profit_loss >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {% if holding.profit_loss >= 0 %}+{% endif %}${{ "%.2f"|format(holding.profit_loss) }}
                                </td>
                                <td class="text-end {% if holding.profit_loss_percentage >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {% if holding.profit_loss_percentage >= 0 %}+{% endif %}{{ "%.1f"|format(holding.profit_loss_percentage) }}%
                                </td>
                                <td class="text-end">{{ "%.1f"|format(holding.portfolio_percentage) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Add New Stock -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-plus-circle"></i> Add New Stock</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_stock') }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="symbol" class="form-label">Stock Symbol</label>
                                <input type="text" class="form-control" id="symbol" name="symbol"
                                       placeholder="e.g., AAPL, TSLA" required>
                                <small class="text-muted">Enter the stock ticker symbol</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="purchase_value" class="form-label">Initial Purchase Value ($)</label>
                                <input type="number" class="form-control" id="purchase_value" name="purchase_value"
                                       step="0.01" min="0" placeholder="1000.00" required>
                                <small class="text-muted">Total amount invested</small>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-info w-100">
                        <i class="fas fa-plus"></i> Add Stock to Portfolio
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Buy/Sell Transactions -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-exchange-alt"></i> Buy/Sell Transactions</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">Add or subtract from your existing holdings</p>
                <form method="POST" action="{{ url_for('transact_etf') }}">
                    <div class="mb-3">
                        <label for="etf_symbol" class="form-label">Stock Symbol</label>
                        <select class="form-control" id="etf_symbol" name="etf_symbol" required>
                            <option value="">Select Stock</option>
                            {% for holding in holdings_list %}
                            <option value="{{ holding.symbol }}">{{ holding.symbol }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="transaction_type" class="form-label">Transaction Type</label>
                                <select class="form-control" id="transaction_type" name="transaction_type" required>
                                    <option value="buy">Buy (Add)</option>
                                    <option value="sell">Sell (Remove)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="amount" class="form-label">Amount ($)</label>
                                <input type="number" class="form-control" id="amount" name="amount"
                                       step="0.01" min="0" placeholder="400.00" required>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-exchange-alt"></i> Execute Transaction
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Update Market Values -->
{% if holdings_list %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-refresh"></i> Update Market Values</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <small><i class="fas fa-info-circle"></i> Update current market values for all your holdings. Purchase values are managed separately.</small>
                </div>
                <form method="POST" action="{{ url_for('update_portfolio') }}">
                    <div class="row">
                        {% for holding in holdings_list %}
                        <div class="col-md-4 mb-3">
                            <label for="{{ holding.symbol.lower() }}_value" class="form-label">{{ holding.symbol }} Market Value ($)</label>
                            <input type="number" class="form-control stock-value-input"
                                   id="{{ holding.symbol.lower() }}_value"
                                   name="{{ holding.symbol.lower() }}_value"
                                   step="0.01" min="0"
                                   value="{{ holding.market_value }}" required>
                            <small class="text-muted">
                                Purchase: ${{ "%.2f"|format(holding.purchase_value) }}
                                {% if holding.profit_loss >= 0 %}
                                <span class="text-success">+${{ "%.2f"|format(holding.profit_loss) }}</span>
                                {% else %}
                                <span class="text-danger">${{ "%.2f"|format(holding.profit_loss) }}</span>
                                {% endif %}
                            </small>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="alert alert-secondary">
                        <small>Total: $<span id="total_value">{{ "%.2f"|format(latest_snapshot.total_market_value if latest_snapshot else 0) }}</span></small>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-sync"></i> Update Portfolio Market Values
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Update Purchase Values -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5><i class="fas fa-cog"></i> Update Purchase Values</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning mb-3">
                    <small><i class="fas fa-exclamation-triangle"></i> <strong>Advanced:</strong> Manually adjust your total invested amounts. Use buy/sell for normal transactions.</small>
                </div>
                <form method="POST" action="{{ url_for('update_etf_holdings') }}">
                    <div class="row">
                        {% for holding in holdings_list %}
                        <div class="col-md-4 mb-3">
                            <label for="{{ holding.symbol.lower() }}_purchase" class="form-label">{{ holding.symbol }} Purchase Value ($)</label>
                            <input type="number" class="form-control"
                                   id="{{ holding.symbol.lower() }}_purchase"
                                   name="{{ holding.symbol.lower() }}_purchase"
                                   step="0.01" min="0"
                                   value="{{ holding.purchase_value }}" required>
                            <small class="text-muted">Current: ${{ "%.2f"|format(holding.purchase_value) }}</small>
                        </div>
                        {% endfor %}
                    </div>

                    <button type="submit" class="btn btn-warning w-100">
                        <i class="fas fa-save"></i> Update Purchase Values
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Portfolio Performance Chart -->
{% if performance_history %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-area"></i> Portfolio Performance (Last 30 Updates)</h5>
            </div>
            <div class="card-body">
                <canvas id="portfolioChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Recent Portfolio Updates -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-history"></i> Recent Portfolio Updates</h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                {% if recent_entries %}
                    {% for entry in recent_entries %}
                    <div class="portfolio-entry d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <strong>Portfolio Update</strong>
                            <small class="text-muted ms-2">{{ entry.date }}</small>
                        </div>
                        <div class="text-end">
                            <div><strong>${{ "%.2f"|format(entry.total_portfolio_value) }}</strong></div>
                            <small class="{% if entry.difference >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if entry.difference >= 0 %}+{% endif %}${{ "%.2f"|format(entry.difference) }}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No portfolio updates recorded yet. Update your portfolio values above!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Auto-calculate total portfolio value
document.addEventListener('DOMContentLoaded', function() {
    const valueInputs = document.querySelectorAll('.stock-value-input');

    valueInputs.forEach(input => {
        input.addEventListener('input', updateTotalValue);
        input.addEventListener('keyup', updateTotalValue);
    });

    updateTotalValue();
});

function updateTotalValue() {
    const valueInputs = document.querySelectorAll('.stock-value-input');
    let total = 0;

    valueInputs.forEach(input => {
        const value = parseFloat(input.value) || 0;
        total += value;
    });

    const totalElement = document.getElementById('total_value');
    if (totalElement) {
        totalElement.textContent = total.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
}

{% if performance_history %}
// Portfolio Performance Chart
const performanceData = {{ performance_history | tojsonfilter | safe }};

if (performanceData.length > 0) {
    const portfolioCtx = document.getElementById('portfolioChart').getContext('2d');

    new Chart(portfolioCtx, {
        type: 'line',
        data: {
            labels: performanceData.map(p => p.date).reverse(),
            datasets: [
                {
                    label: 'Portfolio Value',
                    data: performanceData.map(p => p.total_market_value).reverse(),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    yAxisID: 'y'
                },
                {
                    label: 'Return %',
                    data: performanceData.map(p => p.profit_loss_percentage).reverse(),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Portfolio Value ($)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Return %'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + '%';
                        }
                    }
                }
            }
        }
    });
}
{% endif %}
</script>
{% endblock %}
