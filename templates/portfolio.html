{% extends "base.html" %}

{% block title %}Portfolio - Perfin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-chart-pie"></i> ETF Portfolio Tracker</h1>
        <p class="text-muted">Track your investment portfolio performance and market value updates</p>
    </div>
</div>

<!-- Auto-Update Status Banner -->
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info" id="autoUpdateStatus">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-robot"></i> <strong>Auto-Update Status:</strong> 
                    <span id="updateStatusText">Checking...</span>
                </div>
                <div>
                    <button class="btn btn-sm btn-primary" onclick="triggerAutoUpdate()" id="autoUpdateBtn">
                        <i class="fas fa-sync"></i> Trigger Auto-Update
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Portfolio Overview -->
<div class="row mb-4">
    {% if latest_snapshot %}
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Current Value</h5>
                <h2 class="text-primary">${{ "%.2f"|format(latest_snapshot.total_market_value) }}</h2>
                <small class="text-muted">as of {{ latest_snapshot.date }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Total Invested</h5>
                <h2 class="text-info">${{ "%.2f"|format(latest_snapshot.total_invested) }}</h2>
                <small class="text-muted">all-time contributions</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Profit/Loss</h5>
                <h2 class="{% if latest_snapshot.profit_loss >= 0 %}text-success{% else %}text-danger{% endif %}">
                    ${{ "%.2f"|format(latest_snapshot.profit_loss) }}
                </h2>
                <small class="text-muted">unrealized P/L</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Return %</h5>
                <h2 class="{% if latest_snapshot.profit_loss_percentage >= 0 %}text-success{% else %}text-danger{% endif %}">
                    {{ "%.1f"|format(latest_snapshot.profit_loss_percentage) }}%
                </h2>
                <small class="text-muted">overall return</small>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> Get Started</h5>
            Update your current portfolio value below to begin tracking performance!
        </div>
    </div>
    {% endif %}
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-refresh"></i> Manual ETF Value Update</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('update_portfolio') }}">
                    <div class="mb-3">
                        <label for="nasdaq_value" class="form-label">NASDAQ/NAS Value ($)</label>
                        <input type="number" class="form-control" id="nasdaq_value" name="nasdaq_value" 
                               step="0.01" min="0" placeholder="21000.00" 
                               value="{{ latest_snapshot.nasdaq_value if latest_snapshot else '' }}" required>
                        <small class="text-muted">Current total value of NAS holdings</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="btcc_value" class="form-label">BTCC Value ($)</label>
                        <input type="number" class="form-control" id="btcc_value" name="btcc_value" 
                               step="0.01" min="0" placeholder="2600.00" 
                               value="{{ latest_snapshot.btcc_value if latest_snapshot else '' }}" required>
                        <small class="text-muted">Current total value of BTCC holdings</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="zsp_value" class="form-label">ZSP Value ($)</label>
                        <input type="number" class="form-control" id="zsp_value" name="zsp_value" 
                               step="0.01" min="0" placeholder="23000.00" 
                               value="{{ latest_snapshot.zsp_value if latest_snapshot else '' }}" required>
                        <small class="text-muted">Current total value of ZSP holdings</small>
                    </div>
                    
                    <div class="alert alert-info">
                        <small>Total: $<span id="total_value">0.00</span></small>
                    </div>
                    
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-sync"></i> Manual Update Portfolio Values
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5><i class="fas fa-robot"></i> Alpha Vantage Auto-Update</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> Automatic Updates</h6>
                    <p class="mb-2">Portfolio auto-updates daily at 6 PM using Alpha Vantage API</p>
                    <p class="mb-2"><strong>ETF Mappings:</strong></p>
                    <ul class="mb-2" style="font-size: 0.9em;">
                        <li>NAS → BMO95120.TO (1,123.175 shares)</li>
                        <li>BTCC → BTCC-B.TO (122 shares)</li>
                        <li>ZSP → ZSP.TO (234 shares)</li>
                    </ul>
                    <small class="text-muted">API Key: Y4KO8J7...WULE (5 requests/minute limit)</small>
                </div>
                
                <div class="mb-3">
                    <button class="btn btn-primary w-100" onclick="triggerAutoUpdate()">
                        <i class="fas fa-sync"></i> <span id="triggerBtnText">Trigger Auto-Update Now</span>
                    </button>
                </div>
                
                <div class="mb-3">
                    <h6>Setup Daily Auto-Updates:</h6>
                    <code style="font-size: 0.8em; display: block; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        # Add to crontab (crontab -e)<br>
                        0 18 * * 1-5 cd /path/to/app && python3 auto_portfolio_update.py
                    </code>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ETF Holdings Management -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-cog"></i> ETF Holdings Configuration</h5>
            </div>
            <div class="card-body">
                {% if latest_snapshot %}
                <form method="POST" action="{{ url_for('update_etf_holdings') }}">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="nas_value" class="form-label">NAS Purchase Value ($)</label>
                                <input type="number" class="form-control" id="nas_value" name="nas_value" 
                                       step="0.01" min="0" placeholder="19164.42" required>
                                <small class="text-muted">Total amount invested in NAS ETF</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="etf_btcc_value" class="form-label">BTCC Purchase Value ($)</label>
                                <input type="number" class="form-control" id="etf_btcc_value" name="btcc_value" 
                                       step="0.01" min="0" placeholder="2630.15" required>
                                <small class="text-muted">Total amount invested in BTCC ETF</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="etf_zsp_value" class="form-label">ZSP Purchase Value ($)</label>
                                <input type="number" class="form-control" id="etf_zsp_value" name="zsp_value" 
                                       step="0.01" min="0" placeholder="20006.17" required>
                                <small class="text-muted">Total amount invested in ZSP ETF</small>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Update ETF Holdings
                    </button>
                </form>
                {% else %}
                <div class="alert alert-info">
                    <p><i class="fas fa-info-circle"></i> Please update your portfolio values first to manage ETF holdings.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ETF Transaction Management -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-exchange-alt"></i> ETF Buy/Sell Transactions</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Use this form to properly track ETF purchases and sales. This will add or subtract from your existing holdings.</p>
                <form method="POST" action="{{ url_for('transact_etf') }}">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="etf_symbol" class="form-label">ETF Symbol</label>
                                <select class="form-control" id="etf_symbol" name="etf_symbol" required>
                                    <option value="">Select ETF</option>
                                    <option value="NAS">NAS (NASDAQ)</option>
                                    <option value="BTCC">BTCC (Bitcoin)</option>
                                    <option value="ZSP">ZSP (S&P 500)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="transaction_type" class="form-label">Transaction Type</label>
                                <select class="form-control" id="transaction_type" name="transaction_type" required>
                                    <option value="buy">Buy (Add to holding)</option>
                                    <option value="sell">Sell (Remove from holding)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="amount" class="form-label">Amount ($)</label>
                                <input type="number" class="form-control" id="amount" name="amount"
                                       step="0.01" min="0" placeholder="400.00" required>
                                <small class="text-muted">Amount to add/subtract</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-success form-control">
                                    <i class="fas fa-plus-circle"></i> Execute Transaction
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Portfolio Performance Chart -->
{% if performance_history %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-area"></i> Portfolio Performance (Last 30 Updates)</h5>
            </div>
            <div class="card-body">
                <canvas id="portfolioChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ETF Holdings Summary -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5><i class="fas fa-chart-pie"></i> ETF Holdings Breakdown</h5>
            </div>
            <div class="card-body">
                {% if latest_snapshot %}
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6>NASDAQ/NAS</h6>
                            <h4 class="text-primary">${{ "%.2f"|format(latest_snapshot.nasdaq_value) }}</h4>
                            <small class="text-muted">{{ "%.1f"|format((latest_snapshot.nasdaq_value / latest_snapshot.total_market_value * 100) if latest_snapshot.total_market_value > 0 else 0) }}% of portfolio</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6>BTCC</h6>
                            <h4 class="text-warning">${{ "%.2f"|format(latest_snapshot.btcc_value) }}</h4>
                            <small class="text-muted">{{ "%.1f"|format((latest_snapshot.btcc_value / latest_snapshot.total_market_value * 100) if latest_snapshot.total_market_value > 0 else 0) }}% of portfolio</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6>ZSP</h6>
                            <h4 class="text-success">${{ "%.2f"|format(latest_snapshot.zsp_value) }}</h4>
                            <small class="text-muted">{{ "%.1f"|format((latest_snapshot.zsp_value / latest_snapshot.total_market_value * 100) if latest_snapshot.total_market_value > 0 else 0) }}% of portfolio</small>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <p class="mb-0"><i class="fas fa-info-circle"></i> Update your portfolio values to see ETF breakdown</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Portfolio Updates -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-history"></i> Recent Portfolio Updates</h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                {% if recent_entries %}
                    {% for entry in recent_entries %}
                    <div class="portfolio-entry d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <strong>Portfolio Update</strong>
                            <small class="text-muted ms-2">{{ entry.date }}</small>
                            <div class="small text-muted">
                                NAS: ${{ "%.2f"|format(entry.nasdaq_value or 0) }} | 
                                BTCC: ${{ "%.2f"|format(entry.btcc_value or 0) }} | 
                                ZSP: ${{ "%.2f"|format(entry.zsp_value or 0) }}
                            </div>
                        </div>
                        <div class="text-end">
                            <div><strong>${{ "%.2f"|format(entry.total_portfolio_value) }}</strong></div>
                            <small class="{% if entry.difference >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if entry.difference >= 0 %}+{% endif %}${{ "%.2f"|format(entry.difference) }}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No portfolio updates recorded yet. Update your portfolio values above!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Check auto-update status on page load
document.addEventListener('DOMContentLoaded', function() {
    checkUpdateStatus();
    
    // Auto-calculate total portfolio value
    ['nasdaq_value', 'btcc_value', 'zsp_value'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', updateTotalValue);
            element.addEventListener('keyup', updateTotalValue);
        }
    });
    
    updateTotalValue();
});

function checkUpdateStatus() {
    fetch('/portfolio/last_update_status')
        .then(response => response.json())
        .then(data => {
            const statusText = document.getElementById('updateStatusText');
            const statusBanner = document.getElementById('autoUpdateStatus');
            
            if (data.needs_update) {
                statusText.textContent = `Last update: ${data.last_update_date || 'Never'} - Update needed`;
                statusBanner.className = 'alert alert-warning';
            } else {
                statusText.textContent = `Up to date (${data.last_update_date})`;
                statusBanner.className = 'alert alert-success';
            }
        })
        .catch(error => {
            console.error('Error checking update status:', error);
            document.getElementById('updateStatusText').textContent = 'Status check failed';
        });
}

function triggerAutoUpdate() {
    const btn = document.getElementById('autoUpdateBtn');
    const btnText = document.getElementById('triggerBtnText');
    
    // Disable button and show loading
    btn.disabled = true;
    btnText.textContent = 'Updating...';
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + btnText.textContent;
    
    fetch('/portfolio/auto_update_trigger', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Auto-update started! This may take a minute to complete.', 'success');
            // Check status again after a delay
            setTimeout(() => {
                checkUpdateStatus();
                // Refresh page after update completes
                setTimeout(() => location.reload(), 3000);
            }, 5000);
        } else {
            showToast(`Auto-update failed: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error triggering auto-update:', error);
        showToast('Failed to trigger auto-update. Check console for details.', 'error');
    })
    .finally(() => {
        // Re-enable button
        btn.disabled = false;
        btnText.textContent = 'Trigger Auto-Update Now';
        btn.innerHTML = '<i class="fas fa-sync"></i> ' + btnText.textContent;
    });
}

function updateTotalValue() {
    const nasdaq = parseFloat(document.getElementById('nasdaq_value').value) || 0;
    const btcc = parseFloat(document.getElementById('btcc_value').value) || 0;
    const zsp = parseFloat(document.getElementById('zsp_value').value) || 0;
    const total = nasdaq + btcc + zsp;
    
    document.getElementById('total_value').textContent = total.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = `
        top: 20px; 
        right: 20px; 
        z-index: 9999; 
        min-width: 300px;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.95) !important;
    `;
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}

{% if performance_history %}
// Portfolio Performance Chart
const performanceData = {{ performance_history | tojsonfilter | safe }};

if (performanceData.length > 0) {
    const portfolioCtx = document.getElementById('portfolioChart').getContext('2d');
    
    new Chart(portfolioCtx, {
        type: 'line',
        data: {
            labels: performanceData.map(p => p.date).reverse(),
            datasets: [
                {
                    label: 'Portfolio Value',
                    data: performanceData.map(p => p.total_market_value).reverse(),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    yAxisID: 'y'
                },
                {
                    label: 'Return %',
                    data: performanceData.map(p => p.profit_loss_percentage).reverse(),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Portfolio Value ($)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Return %'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + '%';
                        }
                    }
                }
            }
        }
    });
}
{% endif %}
</script>
{% endblock %}