{% extends "base.html" %}

{% block title %}Calendar - Perfin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-calendar"></i> Calendar View</h1>
        <p class="text-muted">View your activities and spending by date</p>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-search"></i> Date Range</h5>
            </div>
            <div class="card-body">
                <form method="GET" id="dateRangeForm">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" 
                                   value="{{ start_date }}" onchange="updateDateRange()">
                        </div>
                        <div class="col-md-3">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" 
                                   value="{{ end_date }}" onchange="updateDateRange()">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="setDateRange('week')">This Week</button>
                            <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="setDateRange('month')">This Month</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setDateRange('year')">This Year</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-calendar-alt"></i> Calendar</h5>
            </div>
            <div class="card-body">
                <div id="calendar-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <button class="btn btn-outline-primary" onclick="previousMonth()">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <h4 id="currentMonth"></h4>
                        <button class="btn btn-outline-primary" onclick="nextMonth()">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div id="calendar-header" class="calendar-header">
                        <!-- Calendar header will be generated here -->
                    </div>
                    <div id="calendar-grid" class="calendar-grid">
                        <!-- Calendar days will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Day Details Modal - Custom Modal like Dashboard -->
<div id="dayDetailsModalOverlay" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <button onclick="navigateDay(-1)" class="btn btn-sm btn-outline-primary" style="margin-right: auto;">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h5 id="modalDayTitle" style="margin: 0 15px;"><i class="fas fa-calendar-day"></i> Day Details</h5>
            <button onclick="navigateDay(1)" class="btn btn-sm btn-outline-primary" style="margin-right: 10px;">
                <i class="fas fa-chevron-right"></i>
            </button>
            <button onclick="closeDayDetailsModal()" class="modal-close-btn">&times;</button>
        </div>

        <div id="modalDayDetails" class="modal-body">
            <p class="text-muted">Loading...</p>
        </div>
    </div>
</div>

<style>
/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 999999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    box-sizing: border-box;
}

.modal-content {
    background: white;
    border-radius: 10px;
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    z-index: 1000000;
    position: relative;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 30px;
    border-bottom: 1px solid #dee2e6;
    background: #f8f9fa;
    border-radius: 10px 10px 0 0;
}

.modal-header h5 {
    margin: 0;
    color: #333;
    font-size: 1.25rem;
}

.modal-close-btn {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #666;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.modal-close-btn:hover {
    background: #e9ecef;
    color: #333;
}

.modal-body {
    padding: 30px;
}

/* Mobile Modal Styles */
@media (max-width: 768px) {
    .modal-overlay {
        padding: 10px;
    }

    .modal-content {
        max-height: 95vh;
        margin: 0;
    }

    .modal-header {
        padding: 15px 20px;
        gap: 8px;
    }

    .modal-header h5 {
        font-size: 1.1rem;
    }

    .modal-header .btn-sm {
        padding: 4px 8px;
        font-size: 14px;
    }

    .modal-close-btn {
        font-size: 24px;
        width: 35px;
        height: 35px;
    }

    .modal-body {
        padding: 20px;
    }
}

@media (max-width: 576px) {
    .modal-overlay {
        padding: 5px;
    }

    .modal-content {
        max-height: 98vh;
        border-radius: 8px;
    }

    .modal-header {
        padding: 10px 12px;
        border-radius: 8px 8px 0 0;
        gap: 5px;
    }

    .modal-header h5 {
        font-size: 0.9rem;
        margin: 0 5px !important;
    }

    .modal-header .btn-sm {
        padding: 3px 6px;
        font-size: 12px;
    }

    .modal-close-btn {
        font-size: 22px;
        width: 32px;
        height: 32px;
    }

    .modal-body {
        padding: 15px;
    }
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
    width: 100%;
    overflow-x: auto;
}

.calendar-day {
    background: white;
    border: 1px solid #dee2e6;
    padding: 8px;
    min-height: 80px;
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 4px;
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .calendar-day {
        min-height: 60px;
        padding: 4px;
    }
    
    .day-number {
        font-size: 14px;
    }
    
    .activity-dot {
        width: 4px !important;
        height: 4px !important;
        margin: 0.5px !important;
    }
    
    .spending-amount {
        font-size: 8px !important;
    }
    
    .calendar-header-day {
        padding: 5px !important;
        font-size: 12px;
    }
}

@media (max-width: 576px) {
    .calendar-day {
        min-height: 50px;
        padding: 2px;
    }
    
    .day-number {
        font-size: 12px;
    }
    
    .calendar-grid {
        padding: 5px;
        gap: 1px;
    }
}

.calendar-day:hover {
    background: #e3f2fd;
    transform: scale(1.02);
}

.calendar-day.selected {
    background: #2196f3;
    color: white;
}

.calendar-day.other-month {
    background: #f5f5f5;
    color: #999;
}

.calendar-day.today {
    border: 2px solid #ff9800;
    font-weight: bold;
}

.calendar-day.has-data {
    border-left: 4px solid #4caf50;
}

.calendar-day.has-spending {
    border-right: 4px solid #f44336;
}

.day-number {
    font-weight: bold;
    margin-bottom: 4px;
}

.day-activities {
    font-size: 10px;
    line-height: 1.2;
}

.activity-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    display: inline-block;
    margin: 1px;
}

.activity-dot.gym { background-color: #2196f3; }
.activity-dot.work { background-color: #4caf50; }
.activity-dot.jiu-jitsu { background-color: #f44336; }
.activity-dot.skateboarding { background-color: #ff9800; }
.activity-dot.coitus { background-color: #e91e63; }
.activity-dot.sauna { background-color: #795548; }
.activity-dot.supplements { background-color: #9c27b0; }
.activity-dot.smoking { background-color: #607d8b; }
.activity-dot.drinking { background-color: #ff5722; }

.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 10px;
}

.calendar-header-day {
    text-align: center;
    font-weight: bold;
    padding: 10px;
    background: #e9ecef;
    border-radius: 4px;
}

.spending-amount {
    font-size: 10px;
    color: #f44336;
    font-weight: bold;
}
</style>

<script>
let currentDate = new Date();
let selectedDate = null;
let calendarData = {{ calendar_data|tojsonfilter|safe }};

console.log('Calendar data:', calendarData);

function updateDateRange() {
    document.getElementById('dateRangeForm').submit();
}

function setDateRange(period) {
    const today = new Date();
    let startDate, endDate;
    
    switch(period) {
        case 'week':
            const dayOfWeek = today.getDay();
            startDate = new Date(today);
            startDate.setDate(today.getDate() - dayOfWeek);
            endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            break;
        case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            break;
        case 'year':
            startDate = new Date(today.getFullYear(), 0, 1);
            endDate = new Date(today.getFullYear(), 11, 31);
            break;
    }
    
    document.getElementById('start_date').value = startDate.toISOString().split('T')[0];
    document.getElementById('end_date').value = endDate.toISOString().split('T')[0];
    updateDateRange();
}

function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    generateCalendar();
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    generateCalendar();
}

function generateCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    document.getElementById('currentMonth').textContent = 
        new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    // Generate header separately
    let headerHTML = '';
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayNames.forEach(day => {
        headerHTML += `<div class="calendar-header-day">${day}</div>`;
    });
    document.getElementById('calendar-header').innerHTML = headerHTML;
    
    // Generate calendar days
    let calendarHTML = '';
    const dayIterator = new Date(startDate);
    for (let week = 0; week < 6; week++) {
        for (let day = 0; day < 7; day++) {
            const dateStr = dayIterator.toISOString().split('T')[0];
            const dayData = calendarData[dateStr] || {};
            const isCurrentMonth = dayIterator.getMonth() === month;
            const isToday = dayIterator.toDateString() === new Date().toDateString();
            const isSelected = selectedDate && dayIterator.toDateString() === selectedDate.toDateString();
            
            let classes = 'calendar-day';
            if (!isCurrentMonth) classes += ' other-month';
            if (isToday) classes += ' today';
            if (isSelected) classes += ' selected';
            if (dayData.has_personal) classes += ' has-data';
            if (dayData.has_spending) classes += ' has-spending';
            
            calendarHTML += `<div class="${classes}" onclick="selectDate('${dateStr}')">`;
            calendarHTML += `<div class="day-number">${dayIterator.getDate()}</div>`;
            
            if (dayData.activities) {
                calendarHTML += '<div class="day-activities">';
                dayData.activities.forEach(activity => {
                    calendarHTML += `<span class="activity-dot ${activity}"></span>`;
                });
                calendarHTML += '</div>';
            }
            
            if (dayData.spending_total) {
                calendarHTML += `<div class="spending-amount">$${dayData.spending_total}</div>`;
            }
            
            calendarHTML += '</div>';
            
            dayIterator.setDate(dayIterator.getDate() + 1);
        }
        
        if (dayIterator.getMonth() !== month && dayIterator.getMonth() !== (month + 1) % 12) {
            break;
        }
    }
    
    document.getElementById('calendar-grid').innerHTML = calendarHTML;
}

function selectDate(dateStr) {
    // Parse date string as local date to avoid timezone offset issues
    const [year, month, day] = dateStr.split('-').map(Number);
    selectedDate = new Date(year, month - 1, day);
    generateCalendar();
    loadDayDetails(dateStr);
}

function navigateDay(direction) {
    if (!selectedDate) return;

    // Navigate to previous or next day
    const newDate = new Date(selectedDate);
    newDate.setDate(newDate.getDate() + direction);

    // Update selected date
    selectedDate = newDate;

    // Format date string for loading details
    const dateStr = newDate.toISOString().split('T')[0];

    // Update calendar display and load new day details
    generateCalendar();
    loadDayDetails(dateStr);
}

function loadDayDetails(dateStr) {
    const dayData = calendarData[dateStr];

    // Parse date string as local date to avoid timezone issues
    const [year, month, day] = dateStr.split('-').map(Number);
    const localDate = new Date(year, month - 1, day);

    // Update modal title with the selected date
    const formattedDate = localDate.toLocaleDateString('en-US', {
        weekday: 'short',
        month: 'short',
        day: 'numeric'
    });
    document.getElementById('modalDayTitle').innerHTML = `<i class="fas fa-calendar-day"></i> ${formattedDate}`;

    let detailsHTML = `<h6>${localDate.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    })}</h6>`;
    
    if (!dayData || (!dayData.personal && !dayData.spending)) {
        detailsHTML += '<div class="alert alert-info"><i class="fas fa-info-circle"></i> No data recorded for this day</div>';
    } else {
        if (dayData.personal) {
            detailsHTML += '<div class="mb-4"><h6 class="text-primary"><i class="fas fa-user"></i> Personal Activities:</h6>';
            const activities = [];
            if (dayData.personal.gym) activities.push('ðŸ’ª Gym');
            if (dayData.personal.jiu_jitsu) activities.push('ðŸ¥‹ Jiu Jitsu');
            if (dayData.personal.skateboarding) activities.push('ðŸ›¹ Skateboarding');
            if (dayData.personal.work) activities.push('ðŸ’¼ Work');
            if (dayData.personal.coitus) activities.push('â¤ï¸ Coitus');
            if (dayData.personal.sauna) activities.push('ðŸ§–â€â™‚ï¸ Sauna');
            if (dayData.personal.supplements) activities.push('ðŸ’Š Supplements');
            if (dayData.personal.smoking) activities.push('ðŸš¬ Smoking');
            if (dayData.personal.drinking) activities.push('ðŸº Drinking');
            
            if (activities.length > 0) {
                detailsHTML += '<div class="mb-2">';
                activities.forEach(activity => {
                    detailsHTML += `<span class="badge bg-primary me-1 mb-1">${activity}</span>`;
                });
                detailsHTML += '</div>';
            } else {
                detailsHTML += '<p class="text-muted small">No activities logged</p>';
            }
            
            if (dayData.personal.notes) {
                detailsHTML += `<div class="alert alert-light mt-2"><strong>Notes:</strong> ${dayData.personal.notes}</div>`;
            }
            detailsHTML += '</div>';
        }
        
        if (dayData.spending && dayData.spending.length > 0) {
            detailsHTML += '<div><h6 class="text-success"><i class="fas fa-wallet"></i> Spending:</h6>';
            let total = 0;
            detailsHTML += '<div class="table-responsive"><table class="table table-sm">';
            dayData.spending.forEach(expense => {
                detailsHTML += `<tr>
                    <td>${expense.description}</td>
                    <td class="text-end text-success fw-bold">$${expense.amount}</td>
                </tr>`;
                total += parseFloat(expense.amount);
            });
            detailsHTML += `<tr class="table-active">
                <td><strong>Total:</strong></td>
                <td class="text-end"><strong class="text-success">$${total.toFixed(2)}</strong></td>
            </tr></table></div></div>`;
        }
    }
    
    document.getElementById('modalDayDetails').innerHTML = detailsHTML;
    openDayDetailsModal();
}

function openDayDetailsModal() {
    document.getElementById('dayDetailsModalOverlay').style.display = 'block';
}

function closeDayDetailsModal() {
    document.getElementById('dayDetailsModalOverlay').style.display = 'none';
}

// Close modal when clicking on overlay (outside modal content)
document.addEventListener('click', function(e) {
    const overlay = document.getElementById('dayDetailsModalOverlay');
    if (e.target === overlay) {
        closeDayDetailsModal();
    }
});

// Initialize calendar on page load
document.addEventListener('DOMContentLoaded', function() {
    generateCalendar();
});
</script>
{% endblock %}